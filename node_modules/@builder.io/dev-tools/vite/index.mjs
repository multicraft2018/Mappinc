import{hostname as f}from"os";import{createDevTools as m}from"../core/index.mjs";import{createDevToolsNodeSys as $}from"../node/index.mjs";import{createDevToolsServer as b}from"../server/index.mjs";async function p(s,c){let t=await s.readFile(c);return typeof t=="string"?u(t):null}function u(s){let c={},t=s.replace(/\r\n?/gm,`
`),e;for(;(e=w.exec(t))!=null;){let l=e[1],n=e[2]||"";n=n.trim();let r=n[0];n=n.replace(/^(['"`])([\s\S]*)\1$/gm,"$2"),r==='"'&&(n=n.replace(/\\n/g,`
`),n=n.replace(/\\r/g,"\r")),c[l]=n}return c}var w=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/gm;function j(s={}){return{name:"vite-plugin-builder-dev-tools",async configureServer(t){let e=await $({getRootDir:()=>t.config.root}),l=await m(e),n=await b({...l,getClientId:()=>"vite-builder-dev-tools",getLocalHostname:()=>e.hash(f()),closeAppServer:async()=>{e.debug("close server"),await t?.close()},restartAppServer:async()=>{e.debug("restart server"),await t?.restart()},enableAppWatch:async r=>{if(r){e.debug("enable watch"),t?.watcher.add(t.config.root);let o=e.join(t.config.root,".git"),a=e.join(t.config.root,"node_modules");t?.watcher.unwatch([o,a])}else e.debug("disable watch"),t?.watcher.unwatch(t.config.root);return r},...e,...s});t.watcher.on("change",async r=>{if(r.includes(".env")){let o=await p(e,r);o&&Object.keys(o).forEach(i=>{process.env[i]=o[i]})}}),t.middlewares.use(async(r,o,a)=>{try{let i=o.end;o.end=function(...g){if((o.getHeader("Content-Type")||"").toString().includes("text/html")){let d=n.getClientInjectScript();o.write(`<script>${d}</script>`)}return i.apply(this,g)},a()}catch(i){a(i)}})}}}export{j as builderDevTools};
